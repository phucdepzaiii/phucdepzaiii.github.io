<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Baccarat Tích Hợp - Dual Analysis Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ffd700, #ff6b6b, #4ecdc4, #667eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(30deg); }
        }

        .disclaimer {
            color: #ffd700;
            font-size: 1em;
            padding: 10px 25px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 20px;
            border: 1px solid #ffd700;
            display: inline-block;
        }

        /* Systems Comparison Panel */
        .systems-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .system-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .system-card.system1 {
            border-color: #667eea;
        }

        .system-card.system2 {
            border-color: #ff6b6b;
        }

        .system-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .system1 .system-title {
            color: #667eea;
        }

        .system2 .system-title {
            color: #ff6b6b;
        }

        .prediction-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .pred-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .pred-label {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 5px;
        }

        .pred-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .pred-value.high {
            color: #4ecdc4;
        }

        /* Consensus Panel */
        .consensus-panel {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.2), rgba(255, 107, 107, 0.2));
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #4ecdc4;
            text-align: center;
        }

        .consensus-title {
            font-size: 1.5em;
            color: #4ecdc4;
            margin-bottom: 20px;
        }

        .consensus-result {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .consensus-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px 30px;
            border-radius: 15px;
            min-width: 150px;
        }

        .consensus-item.agreed {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.3), rgba(39, 174, 96, 0.3));
            border: 2px solid #2ecc71;
            animation: pulseGreen 2s infinite;
        }

        @keyframes pulseGreen {
            0%, 100% { box-shadow: 0 0 20px rgba(46, 204, 113, 0.5); }
            50% { box-shadow: 0 0 40px rgba(46, 204, 113, 0.8); }
        }

        .consensus-item.disagreed {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
        }

        /* Statistics Panel */
        .statistics-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .stat-value.positive {
            color: #2ecc71;
        }

        .stat-value.negative {
            color: #e74c3c;
        }

        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .chart-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #4ecdc4;
        }

        .chart-canvas {
            width: 100%;
            height: 200px;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 100%;
            gap: 2px;
        }

        .chart-bar {
            flex: 1;
            max-width: 20px;
            border-radius: 3px 3px 0 0;
            position: relative;
            transition: all 0.3s;
        }

        .chart-bar.win {
            background: linear-gradient(180deg, #2ecc71, #27ae60);
        }

        .chart-bar.loss {
            background: linear-gradient(180deg, #e74c3c, #c0392b);
        }

        .chart-bar:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 10;
        }

        /* Combined Statistics Table */
        .combined-stats-table {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            color: #4ecdc4;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Input Controls */
        .input-section {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .main-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-player {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-banker {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-tie {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .secondary-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-action {
            background: linear-gradient(135deg, #fa709a, #fee140);
            color: #333;
            padding: 10px 20px;
            font-size: 1em;
        }

        #historyDisplay {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            min-height: 50px;
        }

        .history-item {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .history-item.player {
            background: rgba(102, 126, 234, 0.3);
            color: #667eea;
        }

        .history-item.banker {
            background: rgba(245, 87, 108, 0.3);
            color: #f5576c;
        }

        .history-item.tie {
            background: rgba(0, 242, 254, 0.3);
            color: #00f2fe;
        }

        /* Win/Loss Indicators */
        .result-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 10px;
            font-size: 0.8em;
            line-height: 20px;
            text-align: center;
        }

        .result-indicator.win {
            background: #2ecc71;
            color: white;
        }

        .result-indicator.loss {
            background: #e74c3c;
            color: white;
        }

        /* Streak Display */
        .streak-display {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 10px;
            margin-top: 10px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .streak-item {
            text-align: center;
        }

        .streak-label {
            font-size: 0.85em;
            color: #aaa;
        }

        .streak-value {
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 5px;
        }

        .streak-value.win-streak {
            color: #2ecc71;
        }

        .streak-value.loss-streak {
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎰 HỆ THỐNG BACCARAT TÍCH HỢP - DUAL ANALYSIS PRO 🎰</h1>
            <p class="disclaimer">⚠️ Phân tích từ 2 hệ thống độc lập - Chỉ đề xuất khi đồng thuận</p>
        </div>

        <!-- Systems Comparison Panel -->
        <div class="systems-panel">
            <div class="system-card system1">
                <div class="system-title">
                    🔮 Hệ Thống 1: AI Multi-Algorithm
                </div>
                <div class="prediction-row">
                    <div class="pred-item">
                        <div class="pred-label">PLAYER</div>
                        <div class="pred-value" id="sys1-player">0%</div>
                    </div>
                    <div class="pred-item">
                        <div class="pred-label">BANKER</div>
                        <div class="pred-value" id="sys1-banker">0%</div>
                    </div>
                    <div class="pred-item">
                        <div class="pred-label">TIE</div>
                        <div class="pred-value" id="sys1-tie">0%</div>
                    </div>
                </div>
                <div class="streak-display">
                    <div class="streak-item">
                        <div class="streak-label">Độ chính xác</div>
                        <div class="streak-value" id="sys1-accuracy">0%</div>
                    </div>
                    <div class="streak-item">
                        <div class="streak-label">Thắng/Thua</div>
                        <div class="streak-value" id="sys1-winloss">0/0</div>
                    </div>
                </div>
            </div>

            <div class="system-card system2">
                <div class="system-title">
                    🎯 Hệ Thống 2: 142857 Algorithm
                </div>
                <div class="prediction-row">
                    <div class="pred-item">
                        <div class="pred-label">PLAYER</div>
                        <div class="pred-value" id="sys2-player">0%</div>
                    </div>
                    <div class="pred-item">
                        <div class="pred-label">BANKER</div>
                        <div class="pred-value" id="sys2-banker">0%</div>
                    </div>
                    <div class="pred-item">
                        <div class="pred-label">TIE</div>
                        <div class="pred-value" id="sys2-tie">0%</div>
                    </div>
                </div>
                <div class="streak-display">
                    <div class="streak-item">
                        <div class="streak-label">Độ chính xác</div>
                        <div class="streak-value" id="sys2-accuracy">0%</div>
                    </div>
                    <div class="streak-item">
                        <div class="streak-label">Thắng/Thua</div>
                        <div class="streak-value" id="sys2-winloss">0/0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Consensus Panel -->
        <div class="consensus-panel">
            <div class="consensus-title">🤝 ĐỀ XUẤT ĐỒNG THUẬN</div>
            <div class="consensus-result" id="consensusResult">
                <div class="consensus-item">
                    <div style="font-size: 1.2em; color: #aaa;">Đang chờ dữ liệu...</div>
                </div>
            </div>
        </div>

        <!-- Statistics Panel -->
        <div class="statistics-panel">
            <h2 style="margin-bottom: 20px;">📊 THỐNG KÊ CHI TIẾT</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Tổng Ván</div>
                    <div class="stat-value" id="totalGames">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Hệ Thống 1 - Max Thắng</div>
                    <div class="stat-value positive" id="sys1-maxWin">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Hệ Thống 1 - Max Thua</div>
                    <div class="stat-value negative" id="sys1-maxLoss">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Hệ Thống 2 - Max Thắng</div>
                    <div class="stat-value positive" id="sys2-maxWin">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Hệ Thống 2 - Max Thua</div>
                    <div class="stat-value negative" id="sys2-maxLoss">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Đồng Thuận Đúng</div>
                    <div class="stat-value positive" id="consensusCorrect">0</div>
                </div>
            </div>
        </div>

        <!-- Charts Container -->
        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-title">📈 Biểu Đồ Hệ Thống 1</div>
                <div class="chart-canvas">
                    <div class="chart-bars" id="chart-system1"></div>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">📈 Biểu Đồ Hệ Thống 2</div>
                <div class="chart-canvas">
                    <div class="chart-bars" id="chart-system2"></div>
                </div>
            </div>
        </div>

        <!-- Combined Statistics Table -->
        <div class="combined-stats-table">
            <h2 style="margin-bottom: 20px;">📋 BẢNG THỐNG KÊ TỔNG HỢP</h2>
            <table>
                <thead>
                    <tr>
                        <th>Hệ Thống</th>
                        <th>Tổng Dự Đoán</th>
                        <th>Đúng</th>
                        <th>Sai</th>
                        <th>Tỷ Lệ Chính Xác</th>
                        <th>Chuỗi Thắng Hiện Tại</th>
                        <th>Max Thắng</th>
                        <th>Max Thua</th>
                        <th>ROI</th>
                    </tr>
                </thead>
                <tbody id="statsTableBody">
                    <tr>
                        <td>Hệ Thống 1</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0%</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0%</td>
                    </tr>
                    <tr>
                        <td>Hệ Thống 2</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0%</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0%</td>
                    </tr>
                    <tr style="background: rgba(78, 205, 196, 0.1);">
                        <td><strong>Đồng Thuận</strong></td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0%</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0%</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Input Section -->
        <div class="input-section">
            <h2 style="margin-bottom: 15px;">🎲 NHẬP KẾT QUẢ</h2>
            <div class="main-buttons">
                <button class="btn-player" onclick="addResult('P')">👤 PLAYER</button>
                <button class="btn-banker" onclick="addResult('B')">🏦 BANKER</button>
                <button class="btn-tie" onclick="addResult('T')">🤝 TIE</button>
            </div>
            <div class="secondary-buttons">
                <button class="btn-action" onclick="undoLast()">↩️ Hoàn Tác</button>
                <button class="btn-action" onclick="clearAll()">🗑️ Xóa Tất Cả</button>
                <button class="btn-action" onclick="generateDemo()">🎲 Demo (30 ván)</button>
            </div>
            <div id="historyDisplay"></div>
        </div>
    </div>

    <script>
        // ===== SYSTEM 1: Multi-Algorithm System =====
        class System1Analyzer {
            constructor() {
                this.history = [];
                this.predictions = [];
                this.results = [];
                this.currentStreak = 0;
                this.maxWinStreak = 0;
                this.maxLossStreak = 0;
                this.currentLossStreak = 0;
                this.wins = 0;
                this.losses = 0;
            }

            predict(history) {
                if (history.length < 3) {
                    return { P: 33.3, B: 33.3, T: 33.3 };
                }

                // Simplified multi-algorithm prediction
                const predictions = [];
                
                // Markov Chain
                const markovPred = this.markovPredict(history);
                if (markovPred) predictions.push({ ...markovPred, weight: 0.3 });
                
                // Pattern Recognition
                const patternPred = this.patternPredict(history);
                if (patternPred) predictions.push({ ...patternPred, weight: 0.3 });
                
                // Statistical
                const statPred = this.statisticalPredict(history);
                predictions.push({ ...statPred, weight: 0.4 });
                
                return this.combinePredictions(predictions);
            }

            markovPredict(history) {
                if (history.length < 4) return null;
                
                const last3 = history.slice(-3).join('');
                const transitions = {};
                
                for (let i = 0; i < history.length - 3; i++) {
                    const state = history.slice(i, i + 3).join('');
                    const next = history[i + 3];
                    
                    if (!transitions[state]) {
                        transitions[state] = { P: 0, B: 0, T: 0, total: 0 };
                    }
                    transitions[state][next]++;
                    transitions[state].total++;
                }
                
                if (transitions[last3]) {
                    const t = transitions[last3];
                    return {
                        P: (t.P / t.total) * 100,
                        B: (t.B / t.total) * 100,
                        T: (t.T / t.total) * 100
                    };
                }
                return null;
            }

            patternPredict(history) {
                if (history.length < 5) return null;
                
                // Check for streaks
                const last5 = history.slice(-5);
                const counts = { P: 0, B: 0, T: 0 };
                last5.forEach(r => counts[r]++);
                
                // If strong streak detected
                const maxCount = Math.max(counts.P, counts.B, counts.T);
                if (maxCount >= 4) {
                    const prediction = { P: 25, B: 25, T: 25 };
                    if (counts.P === maxCount) prediction.P = 50;
                    else if (counts.B === maxCount) prediction.B = 50;
                    else prediction.T = 50;
                    return prediction;
                }
                
                return null;
            }

            statisticalPredict(history) {
                const counts = { P: 0, B: 0, T: 0 };
                history.forEach(r => counts[r]++);
                
                const total = history.length;
                const expected = total / 3;
                
                // Regression to mean
                const prediction = {
                    P: 33.3 + (expected - counts.P) * 1.5,
                    B: 33.3 + (expected - counts.B) * 1.5,
                    T: 33.3 + (expected - counts.T) * 1.5
                };
                
                // Normalize
                const sum = prediction.P + prediction.B + prediction.T;
                return {
                    P: (prediction.P / sum) * 100,
                    B: (prediction.B / sum) * 100,
                    T: (prediction.T / sum) * 100
                };
            }

            combinePredictions(predictions) {
                let combined = { P: 0, B: 0, T: 0 };
                let totalWeight = 0;
                
                predictions.forEach(pred => {
                    combined.P += pred.P * pred.weight;
                    combined.B += pred.B * pred.weight;
                    combined.T += pred.T * pred.weight;
                    totalWeight += pred.weight;
                });
                
                if (totalWeight > 0) {
                    combined.P /= totalWeight;
                    combined.B /= totalWeight;
                    combined.T /= totalWeight;
                }
                
                return combined;
            }

            recordResult(prediction, actual) {
                const maxProb = Math.max(prediction.P, prediction.B, prediction.T);
                let predicted = null;
                
                if (maxProb > 35) {
                    if (maxProb === prediction.P) predicted = 'P';
                    else if (maxProb === prediction.B) predicted = 'B';
                    else if (maxProb === prediction.T) predicted = 'T';
                }
                
                this.predictions.push(predicted);
                this.results.push(actual);
                
                if (predicted) {
                    const isCorrect = predicted === actual;
                    
                    if (isCorrect) {
                        this.wins++;
                        this.currentStreak++;
                        this.currentLossStreak = 0;
                        this.maxWinStreak = Math.max(this.maxWinStreak, this.currentStreak);
                    } else {
                        this.losses++;
                        this.currentStreak = 0;
                        this.currentLossStreak++;
                        this.maxLossStreak = Math.max(this.maxLossStreak, this.currentLossStreak);
                    }
                    
                    return isCorrect;
                }
                return null;
            }

            getAccuracy() {
                const total = this.wins + this.losses;
                return total > 0 ? (this.wins / total) * 100 : 0;
            }

            getRecentResults(limit = 30) {
                return this.results.slice(-limit).map((result, i) => {
                    const predIndex = this.results.length - limit + i;
                    return this.predictions[predIndex] === result;
                });
            }
        }

        // ===== SYSTEM 2: 142857 Algorithm System =====
        class System2Analyzer {
            constructor() {
                this.base = 142857;
                this.sequence = [1, 4, 2, 8, 5, 7];
                this.phase = 0;
                this.history = [];
                this.predictions = [];
                this.results = [];
                this.currentStreak = 0;
                this.maxWinStreak = 0;
                this.maxLossStreak = 0;
                this.currentLossStreak = 0;
                this.wins = 0;
                this.losses = 0;
            }

            predict(history) {
                if (history.length < 3) {
                    return { P: 33.3, B: 33.3, T: 33.3 };
                }

                const currentPhase = this.sequence[this.phase];
                const multiplier = (currentPhase * this.base) % 1000000;
                
                // Magic number calculation
                const digits = multiplier.toString().padStart(6, '0').split('').map(Number);
                const sum = digits.reduce((a, b) => a + b, 0) || 1;
                
                const playerWeight = (digits[0] + digits[2] + digits[4]) / sum;
                const bankerWeight = (digits[1] + digits[3] + digits[5]) / sum;
                const tieWeight = Math.max(0.05, 1 - playerWeight - bankerWeight);
                
                // Combine with pattern analysis
                const patterns = this.analyzePatterns(history);
                
                const prediction = {
                    P: playerWeight * 60 + patterns.P * 40,
                    B: bankerWeight * 60 + patterns.B * 40,
                    T: tieWeight * 100
                };
                
                // Normalize
                const total = prediction.P + prediction.B + prediction.T;
                return {
                    P: (prediction.P / total) * 100,
                    B: (prediction.B / total) * 100,
                    T: (prediction.T / total) * 100
                };
            }

            analyzePatterns(history) {
                const recent = history.slice(-7);
                const counts = { P: 0, B: 0, T: 0 };
                recent.forEach(r => counts[r]++);
                
                const total = recent.length || 1;
                return {
                    P: (counts.P / total) * 100,
                    B: (counts.B / total) * 100,
                    T: (counts.T / total) * 100
                };
            }

            nextPhase() {
                this.phase = (this.phase + 1) % 6;
            }

            recordResult(prediction, actual) {
                const maxProb = Math.max(prediction.P, prediction.B, prediction.T);
                let predicted = null;
                
                if (maxProb > 35) {
                    if (maxProb === prediction.P) predicted = 'P';
                    else if (maxProb === prediction.B) predicted = 'B';
                    else if (maxProb === prediction.T) predicted = 'T';
                }
                
                this.predictions.push(predicted);
                this.results.push(actual);
                
                if (predicted) {
                    const isCorrect = predicted === actual;
                    
                    if (isCorrect) {
                        this.wins++;
                        this.currentStreak++;
                        this.currentLossStreak = 0;
                        this.maxWinStreak = Math.max(this.maxWinStreak, this.currentStreak);
                    } else {
                        this.losses++;
                        this.currentStreak = 0;
                        this.currentLossStreak++;
                        this.maxLossStreak = Math.max(this.maxLossStreak, this.currentLossStreak);
                    }
                    
                    return isCorrect;
                }
                return null;
            }

            getAccuracy() {
                const total = this.wins + this.losses;
                return total > 0 ? (this.wins / total) * 100 : 0;
            }

            getRecentResults(limit = 30) {
                return this.results.slice(-limit).map((result, i) => {
                    const predIndex = this.results.length - limit + i;
                    return this.predictions[predIndex] === result;
                });
            }
        }

        // ===== INTEGRATED SYSTEM MANAGER =====
        class IntegratedSystem {
            constructor() {
                this.system1 = new System1Analyzer();
                this.system2 = new System2Analyzer();
                this.history = [];
                this.consensusHistory = [];
                this.consensusWins = 0;
                this.consensusLosses = 0;
                this.consensusStreak = 0;
                this.consensusMaxWin = 0;
                this.consensusMaxLoss = 0;
                this.consensusLossStreak = 0;
                this.lastPredictions = { system1: null, system2: null };
            }

            addResult(result) {
                // Record results for both systems
                if (this.lastPredictions.system1) {
                    this.system1.recordResult(this.lastPredictions.system1, result);
                }
                if (this.lastPredictions.system2) {
                    this.system2.recordResult(this.lastPredictions.system2, result);
                }
                
                // Check consensus
                if (this.lastPredictions.system1 && this.lastPredictions.system2) {
                    const consensus = this.checkConsensus(
                        this.lastPredictions.system1,
                        this.lastPredictions.system2
                    );
                    
                    if (consensus.agreed && consensus.prediction) {
                        const isCorrect = consensus.prediction === result;
                        this.consensusHistory.push(isCorrect);
                        
                        if (isCorrect) {
                            this.consensusWins++;
                            this.consensusStreak++;
                            this.consensusLossStreak = 0;
                            this.consensusMaxWin = Math.max(this.consensusMaxWin, this.consensusStreak);
                        } else {
                            this.consensusLosses++;
                            this.consensusStreak = 0;
                            this.consensusLossStreak++;
                            this.consensusMaxLoss = Math.max(this.consensusMaxLoss, this.consensusLossStreak);
                        }
                    }
                }
                
                // Add to history and advance phase for system 2
                this.history.push(result);
                this.system2.nextPhase();
            }

            analyze() {
                const pred1 = this.system1.predict(this.history);
                const pred2 = this.system2.predict(this.history);
                
                this.lastPredictions = {
                    system1: pred1,
                    system2: pred2
                };
                
                const consensus = this.checkConsensus(pred1, pred2);
                
                return {
                    system1: pred1,
                    system2: pred2,
                    consensus: consensus
                };
            }

            checkConsensus(pred1, pred2) {
                const getMax = (pred) => {
                    const max = Math.max(pred.P, pred.B, pred.T);
                    if (max < 35) return null;
                    if (max === pred.P) return 'P';
                    if (max === pred.B) return 'B';
                    if (max === pred.T) return 'T';
                    return null;
                };
                
                const max1 = getMax(pred1);
                const max2 = getMax(pred2);
                
                const agreed = max1 && max2 && max1 === max2;
                const confidence = agreed ? 
                    (pred1[max1] + pred2[max1]) / 2 : 0;
                
                return {
                    agreed: agreed,
                    prediction: agreed ? max1 : null,
                    confidence: confidence
                };
            }

            getConsensusAccuracy() {
                const total = this.consensusWins + this.consensusLosses;
                return total > 0 ? (this.consensusWins / total) * 100 : 0;
            }

            reset() {
                this.system1 = new System1Analyzer();
                this.system2 = new System2Analyzer();
                this.history = [];
                this.consensusHistory = [];
                this.consensusWins = 0;
                this.consensusLosses = 0;
                this.consensusStreak = 0;
                this.consensusMaxWin = 0;
                this.consensusMaxLoss = 0;
                this.consensusLossStreak = 0;
                this.lastPredictions = { system1: null, system2: null };
            }
        }

        // ===== GLOBAL VARIABLES =====
        let gameHistory = [];
        let integratedSystem = new IntegratedSystem();

        // ===== UI FUNCTIONS =====
        function addResult(result) {
            gameHistory.push(result);
            integratedSystem.addResult(result);
            updateDisplay();
            analyzeAndUpdate();
        }

        function undoLast() {
            if (gameHistory.length > 0) {
                gameHistory.pop();
                // Reset and replay history
                integratedSystem.reset();
                gameHistory.forEach(r => integratedSystem.addResult(r));
                updateDisplay();
                analyzeAndUpdate();
            }
        }

        function clearAll() {
            if (confirm('Xóa toàn bộ dữ liệu?')) {
                gameHistory = [];
                integratedSystem.reset();
                updateDisplay();
                analyzeAndUpdate();
            }
        }

        function generateDemo() {
            const options = ['P', 'B', 'T'];
            const weights = [0.45, 0.45, 0.1];
            
            for (let i = 0; i < 30; i++) {
                const random = Math.random();
                let result;
                if (random < weights[0]) result = 'P';
                else if (random < weights[0] + weights[1]) result = 'B';
                else result = 'T';
                
                gameHistory.push(result);
                integratedSystem.addResult(result);
            }
            
            updateDisplay();
            analyzeAndUpdate();
        }

        function updateDisplay() {
            // Update history display
            const historyDiv = document.getElementById('historyDisplay');
            historyDiv.innerHTML = gameHistory.map((result, index) => {
                let className = '';
                switch(result) {
                    case 'P': className = 'player'; break;
                    case 'B': className = 'banker'; break;
                    case 'T': className = 'tie'; break;
                }
                return `<span class="history-item ${className}">${index + 1}. ${result}</span>`;
            }).join('');
            
            // Update total games
            document.getElementById('totalGames').textContent = gameHistory.length;
        }

        function analyzeAndUpdate() {
            if (gameHistory.length === 0) {
                resetUI();
                return;
            }
            
            const analysis = integratedSystem.analyze();
            
            // Update System 1
            updateSystemDisplay(1, analysis.system1, integratedSystem.system1);
            
            // Update System 2
            updateSystemDisplay(2, analysis.system2, integratedSystem.system2);
            
            // Update Consensus
            updateConsensus(analysis.consensus);
            
            // Update Statistics
            updateStatistics();
            
            // Update Charts
            updateCharts();
            
            // Update Combined Table
            updateCombinedTable();
        }

        function updateSystemDisplay(systemNum, prediction, analyzer) {
            const prefix = `sys${systemNum}`;
            
            // Update predictions
            document.getElementById(`${prefix}-player`).textContent = 
                prediction.P.toFixed(1) + '%';
            document.getElementById(`${prefix}-banker`).textContent = 
                prediction.B.toFixed(1) + '%';
            document.getElementById(`${prefix}-tie`).textContent = 
                prediction.T.toFixed(1) + '%';
            
            // Highlight highest
            const values = [
                { id: `${prefix}-player`, value: prediction.P },
                { id: `${prefix}-banker`, value: prediction.B },
                { id: `${prefix}-tie`, value: prediction.T }
            ];
            
            values.forEach(v => {
                document.getElementById(v.id).classList.remove('high');
            });
            
            const max = Math.max(prediction.P, prediction.B, prediction.T);
            if (max > 35) {
                values.find(v => v.value === max).id && 
                document.getElementById(values.find(v => v.value === max).id).classList.add('high');
            }
            
            // Update accuracy and win/loss
            document.getElementById(`${prefix}-accuracy`).textContent = 
                analyzer.getAccuracy().toFixed(1) + '%';
            document.getElementById(`${prefix}-winloss`).textContent = 
                `${analyzer.wins}/${analyzer.losses}`;
            
            // Update max streaks
            document.getElementById(`${prefix}-maxWin`).textContent = 
                analyzer.maxWinStreak;
            document.getElementById(`${prefix}-maxLoss`).textContent = 
                analyzer.maxLossStreak;
        }

        function updateConsensus(consensus) {
            const resultDiv = document.getElementById('consensusResult');
            
            if (consensus.agreed && consensus.prediction) {
                resultDiv.innerHTML = `
                    <div class="consensus-item agreed">
                        <div style="font-size: 1.5em; margin-bottom: 10px;">
                            ✅ ĐỒNG THUẬN
                        </div>
                        <div style="font-size: 2em; font-weight: bold;">
                            ${consensus.prediction === 'P' ? '👤 PLAYER' : 
                              consensus.prediction === 'B' ? '🏦 BANKER' : 
                              '🤝 TIE'}
                        </div>
                        <div style="margin-top: 10px; font-size: 1.1em;">
                            Độ tin cậy: ${consensus.confidence.toFixed(1)}%
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="consensus-item disagreed">
                        <div style="font-size: 1.3em;">
                            ❌ KHÔNG ĐỒNG THUẬN
                        </div>
                        <div style="margin-top: 10px; color: #aaa;">
                            Hai hệ thống có dự đoán khác nhau
                        </div>
                    </div>
                `;
            }
        }

        function updateStatistics() {
            document.getElementById('consensusCorrect').textContent = 
                integratedSystem.consensusWins;
        }

        function updateCharts() {
            // Update System 1 Chart
            const chart1Div = document.getElementById('chart-system1');
            const results1 = integratedSystem.system1.getRecentResults(30);
            chart1Div.innerHTML = results1.map((correct, i) => {
                if (correct === null) return '';
                return `<div class="chart-bar ${correct ? 'win' : 'loss'}" 
                        style="height: ${correct ? '60%' : '40%'};"
                        data-tooltip="Ván ${i + 1}: ${correct ? 'Đúng' : 'Sai'}"></div>`;
            }).join('');
            
            // Update System 2 Chart
            const chart2Div = document.getElementById('chart-system2');
            const results2 = integratedSystem.system2.getRecentResults(30);
            chart2Div.innerHTML = results2.map((correct, i) => {
                if (correct === null) return '';
                return `<div class="chart-bar ${correct ? 'win' : 'loss'}" 
                        style="height: ${correct ? '60%' : '40%'};"
                        data-tooltip="Ván ${i + 1}: ${correct ? 'Đúng' : 'Sai'}"></div>`;
            }).join('');
        }

        function updateCombinedTable() {
            const tbody = document.getElementById('statsTableBody');
            const sys1 = integratedSystem.system1;
            const sys2 = integratedSystem.system2;
            
            const calculateROI = (wins, losses) => {
                const total = wins + losses;
                if (total === 0) return 0;
                return ((wins - losses) / total * 100).toFixed(1);
            };
            
            tbody.innerHTML = `
                <tr>
                    <td>Hệ Thống 1</td>
                    <td>${sys1.wins + sys1.losses}</td>
                    <td>${sys1.wins}</td>
                    <td>${sys1.losses}</td>
                    <td>${sys1.getAccuracy().toFixed(1)}%</td>
                    <td>${sys1.currentStreak}</td>
                    <td>${sys1.maxWinStreak}</td>
                    <td>${sys1.maxLossStreak}</td>
                    <td>${calculateROI(sys1.wins, sys1.losses)}%</td>
                </tr>
                <tr>
                    <td>Hệ Thống 2</td>
                    <td>${sys2.wins + sys2.losses}</td>
                    <td>${sys2.wins}</td>
                    <td>${sys2.losses}</td>
                    <td>${sys2.getAccuracy().toFixed(1)}%</td>
                    <td>${sys2.currentStreak}</td>
                    <td>${sys2.maxWinStreak}</td>
                    <td>${sys2.maxLossStreak}</td>
                    <td>${calculateROI(sys2.wins, sys2.losses)}%</td>
                </tr>
                <tr style="background: rgba(78, 205, 196, 0.1);">
                    <td><strong>Đồng Thuận</strong></td>
                    <td>${integratedSystem.consensusWins + integratedSystem.consensusLosses}</td>
                    <td>${integratedSystem.consensusWins}</td>
                    <td>${integratedSystem.consensusLosses}</td>
                    <td>${integratedSystem.getConsensusAccuracy().toFixed(1)}%</td>
                    <td>${integratedSystem.consensusStreak}</td>
                    <td>${integratedSystem.consensusMaxWin}</td>
                    <td>${integratedSystem.consensusMaxLoss}</td>
                    <td>${calculateROI(integratedSystem.consensusWins, integratedSystem.consensusLosses)}%</td>
                </tr>
            `;
        }

        function resetUI() {
            // Reset all displays to initial state
            document.querySelectorAll('.pred-value').forEach(el => {
                el.textContent = '0%';
                el.classList.remove('high');
            });
            
            document.querySelectorAll('.stat-value').forEach(el => {
                el.textContent = '0';
            });
            
            document.getElementById('consensusResult').innerHTML = `
                <div class="consensus-item">
                    <div style="font-size: 1.2em; color: #aaa;">Đang chờ dữ liệu...</div>
                </div>
            `;
            
            document.getElementById('chart-system1').innerHTML = '';
            document.getElementById('chart-system2').innerHTML = '';
            
            updateCombinedTable();
        }

        // Initialize
        updateDisplay();
        analyzeAndUpdate();
    </script>
</body>
</html>
